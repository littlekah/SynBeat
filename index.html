<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü•≠ SynBeats - Beat Maker</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #0A0A0A;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .synbeats-pro {
            width: 1600px;
            max-width: 100%;
            background: #1E1E1E;
            border-radius: 20px;
            border: 3px solid #FFD700;
            box-shadow: 0 30px 50px rgba(0,0,0,0.9);
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: #2A2A2A;
            padding: 15px 25px;
            border-bottom: 3px solid #FFD700;
            display: flex;
            align-items: center;
            gap: 25px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .manga {
            font-size: 3rem;
            filter: drop-shadow(0 4px 0 #8B4513);
        }

        .title {
            color: #FFD700;
            font-size: 2rem;
            font-weight: 900;
            text-shadow: 3px 3px 0 #8B4513;
        }

        .transport {
            display: flex;
            gap: 15px;
            margin-left: auto;
        }

        .btn {
            background: #3A3A3A;
            border: 2px solid #FFD700;
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.08s;
            font-size: 1.1rem;
        }

        .btn:active {
            transform: translateY(3px);
            background: #FFD700;
            color: black;
        }

        .btn.green {
            background: #2E7D32;
        }

        .btn.red {
            background: #C62828;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #FF4444; }
            100% { transform: scale(1); }
        }

        /* Menu */
        .menu {
            display: flex;
            gap: 20px;
            background: #1A1A1A;
            padding: 10px 25px;
            border-bottom: 2px solid #FFD700;
            flex-wrap: wrap;
        }

        .menu-item {
            color: #FFD700;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .menu-item:hover {
            background: #FFD700;
            color: black;
        }

        /* Main Layout */
        .workspace {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2px;
            background: #0A0A0A;
            padding: 2px;
            height: 700px;
        }

        /* Channel Rack */
        .channel-rack {
            background: #1A1A1A;
            border-right: 3px solid #FFD700;
            overflow-y: auto;
            padding: 15px;
        }

        .rack-header {
            color: #FFD700;
            font-size: 1.3rem;
            font-weight: bold;
            padding: 10px;
            border-bottom: 2px solid #FFD700;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .channel-item {
            background: #2A2A2A;
            border: 2px solid #3A3A3A;
            border-radius: 12px;
            margin-bottom: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.1s;
        }

        .channel-item.active {
            border: 3px solid #FFD700;
            background: #3A3A3A;
            transform: scale(1.02);
        }

        .channel-color {
            width: 30px;
            height: 30px;
            border-radius: 8px;
        }

        .channel-name {
            color: white;
            font-weight: bold;
            flex: 1;
            font-size: 1.1rem;
        }

        .channel-type {
            color: #FFD700;
            font-size: 0.8rem;
            background: #1A1A1A;
            padding: 3px 8px;
            border-radius: 12px;
        }

        /* Upload Section */
        .upload-section {
            margin-top: 20px;
            padding: 15px;
            background: #2A2A2A;
            border-radius: 15px;
            border: 2px dashed #FFD700;
        }

        .upload-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn {
            background: #FFD700;
            color: black;
            padding: 12px;
            border-radius: 25px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
        }

        .voice-item {
            background: #1A1A1A;
            padding: 8px;
            border-radius: 8px;
            margin: 5px 0;
            color: #FFD700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-item button {
            background: #FF4444;
            border: none;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            cursor: pointer;
            margin-left: auto;
        }

        /* Piano Roll */
        .piano-roll {
            background: #1A1A1A;
            padding: 15px;
            overflow: auto;
        }

        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: #2A2A2A;
            border: 2px solid #FFD700;
            color: #FFD700;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .tool-btn.active {
            background: #FFD700;
            color: black;
        }

        .audio-status {
            color: #FF4444;
            font-weight: bold;
            margin-left: auto;
            padding: 8px 20px;
            border-radius: 25px;
            background: #1A1A1A;
            border: 2px solid currentColor;
        }

        /* Grid */
        .grid-container {
            display: flex;
            height: 550px;
            overflow: auto;
            background: #0A0A0A;
            border: 2px solid #FFD700;
            border-radius: 15px;
        }

        .piano-keys {
            width: 100px;
            background: #2A2A2A;
            border-right: 2px solid #FFD700;
            flex-shrink: 0;
        }

        .piano-key {
            height: 40px;
            border-bottom: 1px solid #3A3A3A;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: #FFD700;
            font-weight: bold;
            position: relative;
            cursor: pointer;
        }

        .piano-key:hover {
            background: #FFD70033;
        }

        .piano-key:active {
            background: #FFD700;
            color: black;
        }

        .piano-key.black {
            background: #1A1A1A;
            color: #FFA500;
        }

        .piano-key.white {
            background: #2A2A2A;
        }

        .notes-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(64, 40px);
            grid-template-rows: repeat(48, 40px);
            gap: 1px;
            background: #1A1A1A;
        }

        .grid-cell {
            background: #2A2A2A;
            border: 1px solid #3A3A3A;
            cursor: pointer;
            transition: 0.05s;
        }

        /* CORES DOS INSTRUMENTOS */
        .grid-cell.kick { background: #FF4444 !important; }
        .grid-cell.snare { background: #4CAF50 !important; }
        .grid-cell.hat { background: #45B7D1 !important; }
        .grid-cell.hat-open { background: #9C27B0 !important; }
        .grid-cell.crash { background: #FFD700 !important; }
        .grid-cell.ride { background: #FF9800 !important; }
        .grid-cell.tom-high { background: #E91E63 !important; }
        .grid-cell.tom-mid { background: #8B4513 !important; }
        .grid-cell.tom-low { background: #607D8B !important; }
        .grid-cell.clap { background: #FFFFFF !important; }
        .grid-cell.voice { background: #FF69B4 !important; }

        .grid-cell.active {
            border: 3px solid white !important;
            box-shadow: 0 0 20px #FFD700 !important;
        }

        .grid-cell.playing {
            border: 3px solid #00FF00 !important;
            box-shadow: 0 0 30px #00FF00 !important;
        }

        /* Bottom Bar */
        .bottom-bar {
            background: #2A2A2A;
            padding: 15px 25px;
            border-top: 3px solid #FFD700;
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #FFD700;
            font-weight: bold;
        }

        input[type=range] {
            width: 200px;
            height: 8px;
            background: #FFD700;
            border-radius: 10px;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            border: 2px solid #FFD700;
            cursor: pointer;
        }

        .status {
            color: #FFD700;
            margin-left: auto;
            font-size: 1.1rem;
        }

        .json-btn {
            background: #7B1FA2;
            border: 2px solid #FFD700;
            color: white;
            padding: 10px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="synbeats-pro">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo">
                <span class="manga">ü•≠</span>
                <span class="title">SynBeats</span>
            </div>
            
            <div class="transport">
                <button class="btn" id="playBtn">‚ñ∂ PLAY</button>
                <button class="btn" id="stopBtn">‚èπ STOP</button>
                <button class="btn red" id="activateAudio">üîä ATIVAR SOM</button>
            </div>
        </div>

        <!-- Menu -->
        <div class="menu">
            <div class="menu-item active">FILE</div>
            <div class="menu-item">EDIT</div>
            <div class="menu-item">AUDIO</div>
            <div class="menu-item">PATTERNS</div>
            <div class="menu-item">VIEW</div>
            <div class="menu-item">OPTIONS</div>
            <div class="menu-item">TOOLS</div>
            <div class="menu-item">FOCUS</div>
            <div class="menu-item">HELP</div>
        </div>

        <!-- Workspace -->
        <div class="workspace">
            <!-- Channel Rack -->
            <div class="channel-rack" id="channelRack">
                <div class="rack-header">
                    <span>CHANNEL RACK</span>
                    <span>10</span>
                </div>
                
                <div id="instrumentsList"></div>
                
                <!-- Se√ß√£o de Upload de Vozes -->
                <div class="upload-section">
                    <div class="upload-title">
                        <span>üé§</span> UPLOAD DE VOZES
                    </div>
                    <input type="file" id="audioUpload" accept="audio/*" multiple style="display: none;">
                    <div class="upload-btn" id="uploadBtn">+ Adicionar Voz</div>
                    <div id="voicesList"></div>
                </div>
            </div>

            <!-- Piano Roll -->
            <div class="piano-roll">
                <div class="toolbar">
                    <div class="tool-btn active" id="pencilTool">‚úèÔ∏è PENCIL</div>
                    <div class="tool-btn" id="eraserTool">üóë ERASER</div>
                    <div class="tool-btn" id="copyBtn">üìã COPY</div>
                    <div class="tool-btn" id="pasteBtn">üìå PASTE</div>
                    <div class="tool-btn" id="clearBtn">üóë CLEAR ALL</div>
                    <div class="audio-status" id="audioStatus">üîá √ÅUDIO DESATIVADO</div>
                </div>

                <div class="grid-container">
                    <!-- Piano Keys -->
                    <div class="piano-keys" id="pianoKeys"></div>
                    
                    <!-- Notes Grid -->
                    <div class="notes-grid" id="notesGrid"></div>
                </div>
            </div>
        </div>

        <!-- Bottom Bar -->
        <div class="bottom-bar">
            <div class="bpm-control">
                <span>‚ö° BPM:</span>
                <input type="range" id="bpmSlider" min="60" max="200" value="120">
                <span id="bpmValue">120</span>
            </div>
            
            <div class="status" id="status">
                ü•≠ 10 instrumentos | 0 vozes
            </div>
            
            <button class="json-btn" id="exportBtn">üì• EXPORT JSON</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
            <button class="json-btn" id="importBtn">üì§ IMPORT JSON</button>
        </div>
    </div>

    <script>
        (function() {
            // Audio Setup
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            let audioCtx = null;
            
            // Config
            let currentInstrument = 0;
            let currentTool = 'pencil';
            let isPlaying = false;
            let currentStep = 0;
            let intervalId = null;
            let bpm = 120;
            let volume = 0.7;
            let audioInitialized = false;
            
            // LISTA DE INSTRUMENTOS COM SONS REALISTAS
            const instruments = [
                { 
                    name: 'KICK', 
                    color: '#FF4444', 
                    className: 'kick',
                    play: (ctx, time, vol, noteFreq) => {
                        const osc1 = ctx.createOscillator();
                        const osc2 = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc1.type = 'triangle';
                        osc2.type = 'sine';
                        
                        osc1.frequency.setValueAtTime(120, time);
                        osc1.frequency.exponentialRampToValueAtTime(60, time + 0.05);
                        
                        osc2.frequency.setValueAtTime(80, time);
                        osc2.frequency.exponentialRampToValueAtTime(40, time + 0.05);
                        
                        gain.gain.setValueAtTime(vol * 0.8, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                        
                        osc1.connect(gain);
                        osc2.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc1.start(time);
                        osc2.start(time);
                        osc1.stop(time + 0.2);
                        osc2.stop(time + 0.2);
                    }
                },
                { 
                    name: 'SNARE', 
                    color: '#4CAF50', 
                    className: 'snare',
                    play: (ctx, time, vol, noteFreq) => {
                        const osc = ctx.createOscillator();
                        const gain1 = ctx.createGain();
                        
                        osc.type = 'triangle';
                        osc.frequency.value = 180;
                        
                        gain1.gain.setValueAtTime(vol * 0.5, time);
                        gain1.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                        
                        const bufferSize = 4096;
                        const noiseNode = ctx.createScriptProcessor(bufferSize, 1, 1);
                        noiseNode.onaudioprocess = (e) => {
                            const output = e.outputBuffer.getChannelData(0);
                            for (let i = 0; i < bufferSize; i++) {
                                output[i] = Math.random() * 2 - 1;
                            }
                        };
                        
                        const gain2 = ctx.createGain();
                        gain2.gain.setValueAtTime(vol * 0.4, time);
                        gain2.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                        
                        osc.connect(gain1);
                        gain1.connect(ctx.destination);
                        
                        noiseNode.connect(gain2);
                        gain2.connect(ctx.destination);
                        
                        osc.start(time);
                        osc.stop(time + 0.1);
                        
                        setTimeout(() => noiseNode.disconnect(), 100);
                    }
                },
                { 
                    name: 'HAT', 
                    color: '#45B7D1', 
                    className: 'hat',
                    play: (ctx, time, vol, noteFreq) => {
                        const bufferSize = 4096;
                        const noiseNode = ctx.createScriptProcessor(bufferSize, 1, 1);
                        noiseNode.onaudioprocess = (e) => {
                            const output = e.outputBuffer.getChannelData(0);
                            for (let i = 0; i < bufferSize; i++) {
                                output[i] = Math.random() * 2 - 1;
                            }
                        };
                        
                        const gain = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        filter.type = 'highpass';
                        filter.frequency.value = 7000;
                        
                        gain.gain.setValueAtTime(vol * 0.3, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
                        
                        noiseNode.connect(filter);
                        filter.connect(gain);
                        gain.connect(ctx.destination);
                        
                        setTimeout(() => noiseNode.disconnect(), 30);
                    }
                },
                { 
                    name: 'HAT OPEN', 
                    color: '#9C27B0', 
                    className: 'hat-open',
                    play: (ctx, time, vol, noteFreq) => {
                        const bufferSize = 4096;
                        const noiseNode = ctx.createScriptProcessor(bufferSize, 1, 1);
                        noiseNode.onaudioprocess = (e) => {
                            const output = e.outputBuffer.getChannelData(0);
                            for (let i = 0; i < bufferSize; i++) {
                                output[i] = Math.random() * 2 - 1;
                            }
                        };
                        
                        const gain = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        filter.type = 'highpass';
                        filter.frequency.value = 6000;
                        
                        gain.gain.setValueAtTime(vol * 0.3, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.3);
                        
                        noiseNode.connect(filter);
                        filter.connect(gain);
                        gain.connect(ctx.destination);
                        
                        setTimeout(() => noiseNode.disconnect(), 300);
                    }
                },
                { 
                    name: 'CRASH', 
                    color: '#FFD700', 
                    className: 'crash',
                    play: (ctx, time, vol, noteFreq) => {
                        const bufferSize = 4096;
                        const noiseNode = ctx.createScriptProcessor(bufferSize, 1, 1);
                        noiseNode.onaudioprocess = (e) => {
                            const output = e.outputBuffer.getChannelData(0);
                            for (let i = 0; i < bufferSize; i++) {
                                output[i] = Math.random() * 2 - 1;
                            }
                        };
                        
                        const gain = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        filter.type = 'bandpass';
                        filter.frequency.value = 2000;
                        filter.Q.value = 0.5;
                        
                        gain.gain.setValueAtTime(vol * 0.4, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 1.0);
                        
                        noiseNode.connect(filter);
                        filter.connect(gain);
                        gain.connect(ctx.destination);
                        
                        setTimeout(() => noiseNode.disconnect(), 1000);
                    }
                },
                { 
                    name: 'RIDE', 
                    color: '#FF9800', 
                    className: 'ride',
                    play: (ctx, time, vol, noteFreq) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc.type = 'sine';
                        osc.frequency.value = 800;
                        
                        gain.gain.setValueAtTime(vol * 0.2, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc.start(time);
                        osc.stop(time + 0.5);
                    }
                },
                { 
                    name: 'TOM HIGH', 
                    color: '#E91E63', 
                    className: 'tom-high',
                    play: (ctx, time, vol, noteFreq) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(300, time);
                        osc.frequency.exponentialRampToValueAtTime(200, time + 0.1);
                        
                        gain.gain.setValueAtTime(vol * 0.6, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc.start(time);
                        osc.stop(time + 0.2);
                    }
                },
                { 
                    name: 'TOM MID', 
                    color: '#8B4513', 
                    className: 'tom-mid',
                    play: (ctx, time, vol, noteFreq) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(200, time);
                        osc.frequency.exponentialRampToValueAtTime(150, time + 0.1);
                        
                        gain.gain.setValueAtTime(vol * 0.6, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc.start(time);
                        osc.stop(time + 0.2);
                    }
                },
                { 
                    name: 'TOM LOW', 
                    color: '#607D8B', 
                    className: 'tom-low',
                    play: (ctx, time, vol, noteFreq) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(100, time);
                        osc.frequency.exponentialRampToValueAtTime(70, time + 0.1);
                        
                        gain.gain.setValueAtTime(vol * 0.6, time);
                        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc.start(time);
                        osc.stop(time + 0.2);
                    }
                },
                { 
                    name: 'CLAP', 
                    color: '#FFFFFF', 
                    className: 'clap',
                    play: (ctx, time, vol, noteFreq) => {
                        for (let i = 0; i < 3; i++) {
                            const bufferSize = 4096;
                            const noiseNode = ctx.createScriptProcessor(bufferSize, 1, 1);
                            noiseNode.onaudioprocess = (e) => {
                                const output = e.outputBuffer.getChannelData(0);
                                for (let i = 0; i < bufferSize; i++) {
                                    output[i] = Math.random() * 2 - 1;
                                }
                            };
                            
                            const gain = ctx.createGain();
                            const filter = ctx.createBiquadFilter();
                            filter.type = 'lowpass';
                            filter.frequency.value = 2000;
                            
                            gain.gain.setValueAtTime(vol * 0.2 / (i + 1), time + i * 0.01);
                            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1 + i * 0.01);
                            
                            noiseNode.connect(filter);
                            filter.connect(gain);
                            gain.connect(ctx.destination);
                            
                            setTimeout(() => noiseNode.disconnect(), 200);
                        }
                    }
                }
            ];
            
            // Vozes importadas
            let userVoices = [];
            
            // Notas
            const notes = [];
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            for (let octave = 2; octave <= 6; octave++) {
                for (let i = 0; i < noteNames.length; i++) {
                    notes.push({
                        name: noteNames[i] + octave,
                        octave: octave,
                        isBlack: noteNames[i].includes('#'),
                        freq: 440 * Math.pow(2, (octave - 4) + (i / 12))
                    });
                }
            }
            
            // Sequ√™ncia
            let sequence = [];
            for (let inst = 0; inst < instruments.length; inst++) {
                sequence[inst] = [];
                for (let n = 0; n < notes.length; n++) {
                    sequence[inst][n] = Array(64).fill(false);
                }
            }
            
            // Clipboard
            let clipboard = [];
            
            // DOM Elements
            const instrumentsList = document.getElementById('instrumentsList');
            const voicesList = document.getElementById('voicesList');
            const pianoKeys = document.getElementById('pianoKeys');
            const notesGrid = document.getElementById('notesGrid');
            const playBtn = document.getElementById('playBtn');
            const stopBtn = document.getElementById('stopBtn');
            const activateBtn = document.getElementById('activateAudio');
            const uploadBtn = document.getElementById('uploadBtn');
            const audioUpload = document.getElementById('audioUpload');
            const pencilTool = document.getElementById('pencilTool');
            const eraserTool = document.getElementById('eraserTool');
            const copyBtn = document.getElementById('copyBtn');
            const pasteBtn = document.getElementById('pasteBtn');
            const clearBtn = document.getElementById('clearBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');
            const bpmSlider = document.getElementById('bpmSlider');
            const bpmValue = document.getElementById('bpmValue');
            const status = document.getElementById('status');
            const audioStatus = document.getElementById('audioStatus');
            
            // FUN√á√ÉO PARA INICIALIZAR √ÅUDIO
            async function initializeAudio() {
                if (audioInitialized) return true;
                
                try {
                    audioCtx = new AudioContext();
                    
                    if (audioCtx.state === 'suspended') {
                        await audioCtx.resume();
                    }
                    
                    audioInitialized = true;
                    audioStatus.innerHTML = 'üîä √ÅUDIO ATIVADO';
                    audioStatus.style.color = '#00FF00';
                    activateBtn.textContent = '‚úÖ SOM ATIVADO';
                    activateBtn.style.background = '#2E7D32';
                    
                    // Tocar som de teste
                    setTimeout(() => {
                        if (instruments[0] && instruments[0].play) {
                            instruments[0].play(audioCtx, audioCtx.currentTime, volume, 261.63);
                        }
                    }, 100);
                    
                    return true;
                } catch (error) {
                    console.error('Erro ao inicializar √°udio:', error);
                    audioStatus.innerHTML = '‚ùå ERRO NO √ÅUDIO';
                    return false;
                }
            }
            
            // FUN√á√ÉO PARA TOCAR NOTA
            function playNote(noteIndex, instrumentIndex) {
                if (!audioCtx || audioCtx.state !== 'running') return;
                
                const now = audioCtx.currentTime;
                
                try {
                    if (instrumentIndex < instruments.length) {
                        // Usa o som realista do instrumento
                        if (instruments[instrumentIndex] && instruments[instrumentIndex].play) {
                            instruments[instrumentIndex].play(audioCtx, now, volume, notes[noteIndex].freq);
                        }
                    } else {
                        // Voz do usu√°rio
                        const voiceIndex = instrumentIndex - instruments.length;
                        if (userVoices[voiceIndex] && userVoices[voiceIndex].buffer) {
                            const source = audioCtx.createBufferSource();
                            source.buffer = userVoices[voiceIndex].buffer;
                            
                            const gain = audioCtx.createGain();
                            gain.gain.value = volume;
                            
                            source.connect(gain);
                            gain.connect(audioCtx.destination);
                            
                            source.start(now);
                        }
                    }
                } catch (error) {
                    console.error('Erro ao tocar nota:', error);
                }
            }
            
            // Renderizar instrumentos
            function renderInstruments() {
                instrumentsList.innerHTML = '';
                
                instruments.forEach((inst, index) => {
                    const item = document.createElement('div');
                    item.className = `channel-item ${index === currentInstrument ? 'active' : ''}`;
                    item.dataset.instrument = index;
                    
                    item.innerHTML = `
                        <div class="channel-color" style="background: ${inst.color};"></div>
                        <span class="channel-name">${inst.name}</span>
                        <span class="channel-type">drum</span>
                    `;
                    
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.channel-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        currentInstrument = index;
                    });
                    
                    instrumentsList.appendChild(item);
                });
            }
            
            // Renderizar vozes
            function renderVoices() {
                voicesList.innerHTML = '';
                
                userVoices.forEach((voice, index) => {
                    const voiceItem = document.createElement('div');
                    voiceItem.className = 'voice-item';
                    voiceItem.innerHTML = `
                        <span>üé§ ${voice.name}</span>
                        <button onclick="removeVoice(${index})">‚úï</button>
                    `;
                    voicesList.appendChild(voiceItem);
                });
                
                status.textContent = `ü•≠ ${instruments.length} instrumentos | ${userVoices.length} vozes`;
            }
            
            // Renderizar piano keys
            function renderPianoKeys() {
                pianoKeys.innerHTML = '';
                
                notes.slice().reverse().forEach((note, index) => {
                    const key = document.createElement('div');
                    key.className = `piano-key ${note.isBlack ? 'black' : 'white'}`;
                    key.innerHTML = `${note.name} <span>${note.isBlack ? '‚ôØ' : ''}</span>`;
                    key.dataset.noteIndex = notes.length - 1 - index;
                    
                    key.addEventListener('mousedown', () => {
                        if (!audioInitialized) {
                            alert('Ative o som primeiro!');
                            return;
                        }
                        key.classList.add('active');
                        playNote(notes.length - 1 - index, currentInstrument);
                    });
                    
                    key.addEventListener('mouseup', () => key.classList.remove('active'));
                    key.addEventListener('mouseleave', () => key.classList.remove('active'));
                    
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (!audioInitialized) {
                            alert('Ative o som primeiro!');
                            return;
                        }
                        key.classList.add('active');
                        playNote(notes.length - 1 - index, currentInstrument);
                    });
                    
                    key.addEventListener('touchend', () => key.classList.remove('active'));
                    
                    pianoKeys.appendChild(key);
                });
            }
            
            // FUN√á√ÉO PARA ATUALIZAR CORES DO GRID
            function updateGridColors() {
                const cells = document.querySelectorAll('.grid-cell');
                
                cells.forEach(cell => {
                    cell.className = 'grid-cell';
                    
                    const noteIndex = parseInt(cell.dataset.noteIndex);
                    const step = parseInt(cell.dataset.step);
                    
                    for (let inst = 0; inst < sequence.length; inst++) {
                        if (sequence[inst] && 
                            sequence[inst][noteIndex] && 
                            sequence[inst][noteIndex][step]) {
                            
                            if (inst < instruments.length) {
                                cell.classList.add(instruments[inst].className);
                            } else {
                                cell.classList.add('voice');
                            }
                            break;
                        }
                    }
                });
            }
            
            // Renderizar grid
            function renderGrid() {
                notesGrid.innerHTML = '';
                
                for (let n = notes.length - 1; n >= 0; n--) {
                    for (let s = 0; s < 64; s++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.dataset.noteIndex = n;
                        cell.dataset.step = s;
                        
                        cell.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            if (!audioInitialized) {
                                alert('Ative o som primeiro!');
                                return;
                            }
                            handleCellClick(cell);
                        });
                        
                        cell.addEventListener('mouseenter', (e) => {
                            if (e.buttons === 1 && audioInitialized) {
                                handleCellClick(cell);
                            }
                        });
                        
                        cell.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            if (!audioInitialized) {
                                alert('Ative o som primeiro!');
                                return;
                            }
                            handleCellClick(cell);
                        });
                        
                        cell.addEventListener('touchmove', (e) => {
                            e.preventDefault();
                            if (!audioInitialized) return;
                            
                            const touch = e.touches[0];
                            const elem = document.elementFromPoint(touch.clientX, touch.clientY);
                            if (elem && elem.classList.contains('grid-cell')) {
                                handleCellClick(elem);
                            }
                        });
                        
                        notesGrid.appendChild(cell);
                    }
                }
                
                updateGridColors();
            }
            
            // Handle cell click
            function handleCellClick(cell) {
                const noteIndex = parseInt(cell.dataset.noteIndex);
                const step = parseInt(cell.dataset.step);
                
                switch(currentTool) {
                    case 'pencil':
                        sequence[currentInstrument][noteIndex][step] = !sequence[currentInstrument][noteIndex][step];
                        
                        if (sequence[currentInstrument][noteIndex][step]) {
                            playNote(noteIndex, currentInstrument);
                        }
                        break;
                        
                    case 'eraser':
                        for (let inst = 0; inst < sequence.length; inst++) {
                            if (sequence[inst] && sequence[inst][noteIndex]) {
                                sequence[inst][noteIndex][step] = false;
                            }
                        }
                        break;
                }
                
                updateGridColors();
            }
            
            // Sequenciador
            function startSequencer() {
                if (intervalId) clearInterval(intervalId);
                
                const stepTime = (60 / bpm) * 1000 / 4;
                let step = 0;
                
                function playStep() {
                    for (let inst = 0; inst < sequence.length; inst++) {
                        for (let n = 0; n < notes.length; n++) {
                            if (sequence[inst] && sequence[inst][n] && sequence[inst][n][step]) {
                                playNote(n, inst);
                            }
                        }
                    }
                    
                    document.querySelectorAll('.grid-cell').forEach(cell => {
                        cell.classList.remove('playing');
                    });
                    
                    document.querySelectorAll(`[data-step="${step}"]`).forEach(cell => {
                        cell.classList.add('playing');
                    });
                    
                    step = (step + 1) % 64;
                }
                
                playStep();
                intervalId = setInterval(playStep, stepTime);
            }
            
            // Remover voz
            window.removeVoice = (index) => {
                userVoices.splice(index, 1);
                sequence.splice(instruments.length + index, 1);
                renderVoices();
                renderGrid();
            };
            
            // EVENT LISTENERS
            activateBtn.addEventListener('click', async () => {
                await initializeAudio();
            });
            
            uploadBtn.addEventListener('click', () => {
                if (!audioInitialized) {
                    alert('Ative o som primeiro!');
                    return;
                }
                audioUpload.click();
            });
            
            audioUpload.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                
                for (const file of files) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                        
                        userVoices.push({
                            name: file.name,
                            buffer: audioBuffer
                        });
                        
                        const newIndex = sequence.length;
                        sequence[newIndex] = [];
                        for (let n = 0; n < notes.length; n++) {
                            sequence[newIndex][n] = Array(64).fill(false);
                        }
                    } catch (error) {
                        console.error('Erro ao carregar √°udio:', error);
                    }
                }
                
                renderVoices();
                renderGrid();
            });
            
            playBtn.addEventListener('click', () => {
                if (!audioInitialized) {
                    alert('Ative o som primeiro!');
                    return;
                }
                
                if (!isPlaying) {
                    isPlaying = true;
                    startSequencer();
                }
            });
            
            stopBtn.addEventListener('click', () => {
                isPlaying = false;
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('playing');
                });
            });
            
            pencilTool.addEventListener('click', () => {
                currentTool = 'pencil';
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                pencilTool.classList.add('active');
            });
            
            eraserTool.addEventListener('click', () => {
                currentTool = 'eraser';
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                eraserTool.classList.add('active');
            });
            
            copyBtn.addEventListener('click', () => {
                clipboard = [];
                for (let n = 0; n < notes.length; n++) {
                    clipboard[n] = [...sequence[currentInstrument][n]];
                }
                status.textContent = 'ü•≠ Copiado!';
            });
            
            pasteBtn.addEventListener('click', () => {
                if (clipboard.length > 0) {
                    for (let n = 0; n < notes.length; n++) {
                        if (clipboard[n]) {
                            sequence[currentInstrument][n] = [...clipboard[n]];
                        }
                    }
                    updateGridColors();
                    status.textContent = 'ü•≠ Colado!';
                }
            });
            
            clearBtn.addEventListener('click', () => {
                if (confirm('Limpar todos os instrumentos?')) {
                    for (let inst = 0; inst < sequence.length; inst++) {
                        for (let n = 0; n < notes.length; n++) {
                            if (sequence[inst] && sequence[inst][n]) {
                                sequence[inst][n] = Array(64).fill(false);
                            }
                        }
                    }
                    updateGridColors();
                    status.textContent = 'ü•≠ Tudo limpo!';
                }
            });
            
            bpmSlider.addEventListener('input', (e) => {
                bpm = e.target.value;
                bpmValue.textContent = bpm;
                if (isPlaying) {
                    stopBtn.click();
                    playBtn.click();
                }
            });
            
            exportBtn.addEventListener('click', () => {
                const data = {
                    bpm: bpm,
                    sequence: sequence,
                    instruments: instruments,
                    version: '2.0'
                };
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `synbeats-${Date.now()}.json`;
                a.click();
                
                status.textContent = 'ü•≠ Exportado!';
            });
            
            importBtn.addEventListener('click', () => importFile.click());
            
            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.sequence) {
                                sequence = data.sequence;
                                updateGridColors();
                                status.textContent = 'ü•≠ Importado!';
                            }
                            if (data.bpm) {
                                bpm = data.bpm;
                                bpmSlider.value = bpm;
                                bpmValue.textContent = bpm;
                            }
                        } catch (err) {
                            alert('Erro ao importar arquivo!');
                        }
                    };
                    reader.readAsText(file);
                }
            });
            
            window.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (isPlaying) stopBtn.click();
                    else playBtn.click();
                }
            });
            
            // Inicializar
            renderInstruments();
            renderPianoKeys();
            renderGrid();
            renderVoices();
            
            audioStatus.innerHTML = 'üîá CLIQUE EM "ATIVAR SOM"';
        })();
    </script>
</body>
</html>
